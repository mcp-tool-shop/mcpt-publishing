name: CI

on:
  push:
    paths:
      - src/**
      - scripts/lib/**
      - bin/**
      - schemas/**
      - packages/**
      - package.json
      - .github/workflows/**
  schedule:
    - cron: "0 8 * * 1" # Monday 08:00 UTC
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  issues: write

jobs:
  # ─── Prepublish Gate (push + manual) ────────────────────────────────────────
  prepublish-gate:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Verify tarball contents
        run: |
          PACK=$(npm pack --dry-run --json 2>/dev/null)
          echo "$PACK" | node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('/dev/stdin','utf8'));
            const files = (Array.isArray(data) ? data[0] : data).files.map(f => f.path);
            console.log('Tarball files:', files.length);

            const required = ['README.md', 'LICENSE', 'package.json'];
            const missing = required.filter(r => !files.some(f => f === r || f.endsWith('/' + r)));
            if (missing.length) { console.error('Missing required files:', missing); process.exit(1); }

            const banned = ['.env', 'node_modules', '.git'];
            const bad = files.filter(f => banned.some(b => f.includes(b)));
            if (bad.length) { console.error('Banned files in tarball:', bad); process.exit(1); }

            console.log('Tarball OK');
          "

      - name: Install smoke test
        run: |
          TARBALL=$(npm pack 2>/dev/null)
          mkdir -p /tmp/smoke-test
          cd /tmp/smoke-test
          npm init -y
          npm install "$GITHUB_WORKSPACE/$TARBALL"
          node -e "import('@mcptoolshop/mcpt-publishing/bin/mcpt-publishing.mjs').catch(() => {})" || true
          cd "$GITHUB_WORKSPACE"
          rm -f "$TARBALL"
          rm -rf /tmp/smoke-test

      - name: CLI smoke tests
        run: |
          node bin/mcpt-publishing.mjs --help
          node bin/mcpt-publishing.mjs --version
          node bin/mcpt-publishing.mjs providers --json
          node bin/mcpt-publishing.mjs init --dry-run

      - name: Run tests
        run: npm test

      - name: Verify receipts (if any exist)
        run: |
          shopt -s nullglob
          RECEIPTS=(receipts/**/*.json)
          if [ ${#RECEIPTS[@]} -gt 0 ]; then
            for r in "${RECEIPTS[@]}"; do
              echo "Verifying: $r"
              node bin/mcpt-publishing.mjs verify-receipt "$r" || true
            done
          else
            echo "No receipts to verify"
          fi

  # ─── Weekly Audit (schedule + manual) ──────────────────────────────────────
  audit:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Run audit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node bin/mcpt-publishing.mjs audit

      - name: Commit report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add reports/latest.md reports/latest.json
          git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "chore: update publishing health report [skip ci]"
          git push

      - name: Update pinned issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          TITLE="Publishing Health"

          RED=$(node -e "const d=JSON.parse(require('fs').readFileSync('reports/latest.json','utf8')); process.stdout.write(String(d.counts.RED))")
          YELLOW=$(node -e "const d=JSON.parse(require('fs').readFileSync('reports/latest.json','utf8')); process.stdout.write(String(d.counts.YELLOW))")
          GRAY=$(node -e "const d=JSON.parse(require('fs').readFileSync('reports/latest.json','utf8')); process.stdout.write(String(d.counts.GRAY))")
          GENERATED=$(node -e "const d=JSON.parse(require('fs').readFileSync('reports/latest.json','utf8')); process.stdout.write(d.generated)")

          BODY=$(cat <<EOF
          ## Publishing Health — ${GENERATED}

          **RED: ${RED}** | **YELLOW: ${YELLOW}** | **GRAY: ${GRAY}**

          $(head -20 reports/latest.md | tail -15)

          ---
          [Full report](https://github.com/${REPO}/blob/main/reports/latest.md) | [JSON](https://github.com/${REPO}/blob/main/reports/latest.json)

          _Updated by [CI](https://github.com/${REPO}/actions/workflows/ci.yml)_
          EOF
          )

          ISSUE_NUM=$(gh issue list --repo "$REPO" --search "in:title ${TITLE}" --state open --json number --jq '.[0].number // empty')

          if [ -n "$ISSUE_NUM" ]; then
            gh issue edit "$ISSUE_NUM" --repo "$REPO" --body "$BODY"
            echo "Updated issue #${ISSUE_NUM}"
          else
            gh issue create --repo "$REPO" --title "$TITLE" --body "$BODY" --pin
            echo "Created and pinned new issue"
          fi
